name: Integration Test (NebariApp)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    paths:
      - "examples/**"
      - "dev/**"
      - ".github/workflows/test-integration.yaml"

jobs:
  nebariapp-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      CLUSTER_NAME: pack-integration
    steps:
      - name: Checkout software-pack-template
        uses: actions/checkout@v4

      - name: Checkout nebari-operator (for dev/scripts)
        uses: actions/checkout@v4
        with:
          repository: nebari-dev/nebari-operator
          path: nebari-operator

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: pack-integration

      - name: Set up Helm
        uses: azure/setup-helm@v4

      # ============================================================
      # Infrastructure: MetalLB
      # ============================================================
      - name: Install MetalLB
        run: |
          kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.8/config/manifests/metallb-native.yaml
          kubectl wait --namespace metallb-system \
            --for=condition=available deployment/controller \
            --timeout=90s
          kubectl wait --namespace metallb-system \
            --for=jsonpath='{.status.numberReady}'=1 \
            daemonset/speaker \
            --timeout=90s

      - name: Configure MetalLB IP pool
        run: |
          KIND_NET_CIDR=$(docker network inspect kind -f '{{range .IPAM.Config}}{{.Subnet}}{{"\n"}}{{end}}' | grep '\.' | head -n1)
          BASE_IP=$(echo "${KIND_NET_CIDR}" | awk -F. '{print $1"."$2}')
          kubectl apply -f - <<EOF
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            name: kind-pool
            namespace: metallb-system
          spec:
            addresses:
              - ${BASE_IP}.255.200-${BASE_IP}.255.250
          ---
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
            name: kind-l2
            namespace: metallb-system
          spec:
            ipAddressPools:
              - kind-pool
          EOF

      # ============================================================
      # Infrastructure: Envoy Gateway, cert-manager, Keycloak
      # ============================================================
      - name: Install foundational services
        run: nebari-operator/dev/scripts/services/install.sh

      - name: Setup Keycloak realm
        run: nebari-operator/dev/scripts/services/keycloak/setup.sh

      # ============================================================
      # Install nebari-operator
      # ============================================================
      - name: Install nebari-operator
        run: |
          kubectl apply -f https://github.com/nebari-dev/nebari-operator/releases/latest/download/install.yaml

      - name: Wait for nebari-operator
        run: |
          kubectl wait --for=condition=available deployment/nebari-operator-controller-manager \
            -n nebari-operator-system --timeout=120s

      - name: Label default namespace for operator
        run: kubectl label namespace default nebari.dev/managed=true --overwrite

      # ============================================================
      # Build auth-fastapi image (needed for that example)
      # ============================================================
      - name: Build and load auth-fastapi image
        run: |
          docker build -t ghcr.io/nebari-dev/nebari-software-pack-template/auth-fastapi-example:latest \
            examples/auth-fastapi/
          kind load docker-image \
            ghcr.io/nebari-dev/nebari-software-pack-template/auth-fastapi-example:latest \
            --name pack-integration

      # ============================================================
      # Test: vanilla-yaml
      # ============================================================
      - name: "Deploy vanilla-yaml"
        run: |
          # Apply deployment + service
          kubectl apply -f examples/vanilla-yaml/deployment.yaml \
                        -f examples/vanilla-yaml/service.yaml

          # Apply nebariapp with hostname patched for nebari.local domain
          sed 's/my-pack.nebari.example.com/vanilla.nebari.local/' \
            examples/vanilla-yaml/nebariapp.yaml | kubectl apply -f -

      - name: "Verify vanilla-yaml NebariApp"
        run: |
          kubectl wait --for=condition=ready pod -l app=my-pack --timeout=120s
          kubectl wait --for=condition=Ready nebariapp/my-pack --timeout=120s
          kubectl get httproute -l app.kubernetes.io/managed-by=nebari-operator
          echo "vanilla-yaml: NebariApp Ready"

      - name: "Cleanup vanilla-yaml"
        if: always()
        run: |
          kubectl delete nebariapp my-pack --ignore-not-found --wait --timeout=60s
          kubectl delete -f examples/vanilla-yaml/deployment.yaml \
                         -f examples/vanilla-yaml/service.yaml --ignore-not-found --wait

      # ============================================================
      # Test: kustomize-nginx (production overlay - auth enabled)
      # ============================================================
      - name: "Deploy kustomize-nginx (production)"
        run: |
          kubectl apply -k examples/kustomize-nginx/overlays/production/

      - name: "Verify kustomize-nginx NebariApp"
        run: |
          kubectl wait --for=condition=ready pod -l app=my-pack --timeout=120s
          kubectl wait --for=condition=Ready nebariapp/my-pack --timeout=120s
          kubectl get httproute -l app.kubernetes.io/managed-by=nebari-operator
          # Production overlay has auth enabled - verify SecurityPolicy
          kubectl get securitypolicy
          echo "kustomize-nginx (production): NebariApp Ready with auth"

      - name: "Cleanup kustomize-nginx"
        if: always()
        run: |
          kubectl delete -k examples/kustomize-nginx/overlays/production/ --ignore-not-found --wait --timeout=60s

      # ============================================================
      # Test: basic-nginx (Helm, no auth)
      # ============================================================
      - name: "Deploy basic-nginx"
        run: |
          helm install test-basic examples/basic-nginx/chart/ \
            --set nebariapp.enabled=true \
            --set nebariapp.hostname=basic.nebari.local \
            --wait --timeout 2m

      - name: "Verify basic-nginx NebariApp"
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance=test-basic --timeout=120s
          kubectl wait --for=condition=Ready nebariapp/test-basic-my-pack --timeout=120s
          kubectl get httproute -l app.kubernetes.io/managed-by=nebari-operator
          echo "basic-nginx: NebariApp Ready"

      - name: "Cleanup basic-nginx"
        if: always()
        run: helm uninstall test-basic --wait || true

      # ============================================================
      # Test: auth-fastapi (Helm, auth enabled)
      # ============================================================
      - name: "Deploy auth-fastapi"
        run: |
          helm install test-fastapi examples/auth-fastapi/chart/ \
            --set nebariapp.enabled=true \
            --set nebariapp.hostname=fastapi.nebari.local \
            --set nebariapp.auth.enabled=true \
            --wait --timeout 2m

      - name: "Verify auth-fastapi NebariApp"
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance=test-fastapi --timeout=120s
          kubectl wait --for=condition=Ready nebariapp/test-fastapi-my-pack --timeout=120s
          kubectl get httproute -l app.kubernetes.io/managed-by=nebari-operator
          # Auth enabled - verify SecurityPolicy
          kubectl get securitypolicy
          echo "auth-fastapi: NebariApp Ready with auth"

      - name: "Cleanup auth-fastapi"
        if: always()
        run: helm uninstall test-fastapi --wait || true

      # ============================================================
      # Test: wrap-existing-chart / podinfo (Helm, no auth)
      # ============================================================
      - name: "Deploy wrap-existing-chart (podinfo)"
        run: |
          helm dependency update examples/wrap-existing-chart/chart/
          helm install test-podinfo examples/wrap-existing-chart/chart/ \
            --set nebariapp.enabled=true \
            --set nebariapp.hostname=podinfo.nebari.local \
            --wait --timeout 3m

      - name: "Verify wrap-existing-chart NebariApp"
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance=test-podinfo --timeout=120s
          kubectl wait --for=condition=Ready nebariapp/test-podinfo-my-pack --timeout=120s
          kubectl get httproute -l app.kubernetes.io/managed-by=nebari-operator
          echo "wrap-existing-chart: NebariApp Ready"

      - name: "Cleanup wrap-existing-chart"
        if: always()
        run: helm uninstall test-podinfo --wait || true

      # ============================================================
      # Debug on failure
      # ============================================================
      - name: Debug info on failure
        if: failure()
        run: |
          echo "=== NebariApps ==="
          kubectl get nebariapp -o wide || true
          echo ""
          echo "=== NebariApp details ==="
          kubectl describe nebariapp || true
          echo ""
          echo "=== HTTPRoutes ==="
          kubectl get httproute -A || true
          echo ""
          echo "=== SecurityPolicies ==="
          kubectl get securitypolicy -A || true
          echo ""
          echo "=== Operator logs ==="
          kubectl logs -n nebari-operator-system deployment/nebari-operator-controller-manager \
            --tail=100 || true
          echo ""
          echo "=== Pods ==="
          kubectl get pods -A || true
          echo ""
          echo "=== Events ==="
          kubectl get events --sort-by=.lastTimestamp | tail -50 || true
