# -*- mode: Python -*-
# Tiltfile for Nebari Software Pack local development
#
# This Tiltfile builds the FastAPI example and deploys it via Helm.
# For the basic-nginx and podinfo examples, use the Makefile targets instead
# since they don't require image builds.
#
# Usage:
#   cd dev && tilt up
#
# References:
#   https://docs.tilt.dev/helm.html
#   https://docs.tilt.dev/api.html#api.allow_k8s_contexts

# Increase timeout for image pulls
update_settings(k8s_upsert_timeout_secs=300)

# Safety: Only allow deployment to our local k3d cluster
allow_k8s_contexts('k3d-my-pack-dev')

# Build the FastAPI image and push to local registry
docker_build(
    'localhost:5005/my-pack-fastapi',
    context='../examples/auth-fastapi',
    dockerfile='../examples/auth-fastapi/Dockerfile',
    live_update=[
        sync('../examples/auth-fastapi/app/', '/app/'),
    ],
)

# Deploy the FastAPI chart via Helm
k8s_yaml(helm(
    '../examples/auth-fastapi/chart',
    name='my-pack',
    namespace='default',
    set=[
        'nebariapp.enabled=false',
        'image.repository=localhost:5005/my-pack-fastapi',
        'image.tag=latest',
    ],
))

# Configure port forwarding
k8s_resource(
    workload='my-pack-my-pack',
    port_forwards=['8080:8000'],
    labels=['my-pack'],
)
